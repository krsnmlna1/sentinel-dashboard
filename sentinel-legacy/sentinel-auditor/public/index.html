<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crypto Ruthless Auditor</title>
    <style>
      body {
        background-color: #0d1117;
        color: #c9d1d9;
        font-family: "Courier New", Courier, monospace;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 50px;
      }
      .container {
        max-width: 800px;
        width: 100%;
        border: 1px solid #30363d;
        padding: 20px;
        border-radius: 6px;
        background-color: #161b22;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.1);
      }
      h1 {
        color: #ff4d4d;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      .upload-area {
        border: 2px dashed #30363d;
        padding: 40px;
        text-align: center;
        margin: 20px 0;
        cursor: pointer;
        transition: 0.3s;
      }
      .upload-area:hover {
        border-color: #58a6ff;
        background-color: #0d1117;
      }
      button {
        background-color: #238636;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        width: 100%;
        font-family: inherit;
        font-weight: bold;
        border-radius: 5px;
      }
      button:hover {
        filter: brightness(1.1);
      }
      button:disabled {
        background-color: #30363d;
        cursor: not-allowed;
      }
      #result {
        margin-top: 20px;
        white-space: pre-wrap; /* Biar format barisnya rapi */
        line-height: 1.6;
        display: none;
        border-top: 1px solid #30363d;
        padding-top: 20px;
      }
      .loading {
        color: #f0ad4e;
        text-align: center;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è Ruthless Auditor</h1>

      <div
        style="
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          justify-content: center;
        "
      >
        <button
          onclick="switchMode('pdf')"
          id="btnPdf"
          style="background: #238636; opacity: 1"
        >
          üìÑ Audit Whitepaper (PDF)
        </button>
        <button
          onclick="switchMode('contract')"
          id="btnContract"
          style="background: #30363d; opacity: 0.6"
        >
          üëæ Audit Smart Contract
        </button>
      </div>

      <div id="modePdf">
        <p style="text-align: center; opacity: 0.7">
          Upload Whitepaper, find narrative lies.
        </p>
        <input type="file" id="pdfFile" accept=".pdf" style="display: none" />
        <div
          class="upload-area"
          onclick="document.getElementById('pdfFile').click()"
        >
          <span id="fileName">Click to select PDF file...</span>
        </div>
        <button onclick="startAuditPDF()" id="auditBtnPdf">
          AUDIT WHITEPAPER
        </button>
      </div>

      <div id="modeContract" style="display: none">
        <p style="text-align: center; opacity: 0.7">
          Paste Contract Address (Verified Etherscan Only).
        </p>
        <input
          type="text"
          id="contractAddress"
          placeholder="Example: 0xdAC17F958D2ee523a2206206994597C13D831ec7"
          style="
            width: 90%;
            padding: 15px;
            background: #0d1117;
            border: 1px solid #30363d;
            color: white;
            border-radius: 5px;
            margin-bottom: 20px;
          "
        />
        <button onclick="startAuditContract()" id="auditBtnContract">
          AUDIT CODE
        </button>
      </div>

      <div id="loading" class="loading">
        <br />
        <span id="loadingText">Reading developer's mind...</span>
      </div>
      <div id="result"></div>
    </div>

    <script>
      // Tab Logic
      function switchMode(mode) {
        document.getElementById("result").style.display = "none";
        if (mode === "pdf") {
          document.getElementById("modePdf").style.display = "block";
          document.getElementById("modeContract").style.display = "none";
          document.getElementById("btnPdf").style.opacity = "1";
          document.getElementById("btnContract").style.opacity = "0.6";
        } else {
          document.getElementById("modePdf").style.display = "none";
          document.getElementById("modeContract").style.display = "block";
          document.getElementById("btnPdf").style.opacity = "0.6";
          document.getElementById("btnContract").style.opacity = "1";
        }
      }

      const fileInput = document.getElementById("pdfFile");
      const fileNameDisplay = document.getElementById("fileName");

      fileInput.addEventListener("change", function () {
        if (this.files && this.files[0])
          fileNameDisplay.textContent = "üìÑ " + this.files[0].name;
      });

      // AUDIT PDF (Old Code)
      async function startAuditPDF() {
        if (!fileInput.files[0]) {
          alert("Select a file first!");
          return;
        }
        runAudit(
          "/audit",
          "POST",
          (formData) => formData.append("whitepaper", fileInput.files[0]),
          true,
        );
      }

      // AUDIT CONTRACT (New Code)
      async function startAuditContract() {
        const address = document.getElementById("contractAddress").value;
        if (!address.startsWith("0x")) {
          alert("Address must start with 0x!");
          return;
        }

        runAudit(
          "/audit-contract",
          "POST",
          (data) => JSON.stringify({ contractAddress: address }),
          false,
        );
      }

      // Generic Server Function
      async function runAudit(endpoint, method, bodyBuilder, isFormData) {
        document.getElementById("loading").style.display = "block";
        document.getElementById("result").style.display = "none";
        document.getElementById("loadingText").innerText =
          "Dissecting data... DeepSeek is thinking hard...";

        try {
          const body = isFormData ? new FormData() : bodyBuilder();
          if (isFormData) bodyBuilder(body); // Execute callback to append data

          const headers = isFormData
            ? {}
            : { "Content-Type": "application/json" };

          const response = await fetch(endpoint, { method, body, headers });
          const data = await response.json();

          if (data.success) {
            const report = data.report
              .replace(
                /\*\*(.*?)\*\*/g,
                '<strong style="color: #ffcccc;">$1</strong>',
              )
              .replace(/üö©|üêõ|üçØ/g, "<br>$&");
            document.getElementById("result").innerHTML = report;
            document.getElementById("result").style.display = "block";
          } else {
            alert("Error: " + data.error);
          }
        } catch (err) {
          alert("Connection failed. Check console.");
          console.error(err);
        } finally {
          document.getElementById("loading").style.display = "none";
        }
      }
    </script>
  </body>
</html>
